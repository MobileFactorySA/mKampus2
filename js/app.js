// Generated by CoffeeScript 1.3.1
(function() {
  var AddView, App, CollectionView, InformationElement, InformationElementView, InformationElements, InformationGroup, InformationGroupShowView, InformationGroupView, InformationGroups, LoadableCollection, LoginView, MenuItem, MenuItems, MenuLayout, Notification, NotificationView, Notifications, NotificationsView, Place, PlaceShowView, PlaceView, Places, Question, QuestionEditView, QuestionView, Questions, Restaurant, RestaurantMenuItemView, RestaurantUser, RestaurantUserShowView, RestaurantUserView, RestaurantUsers, RestaurantView, Restaurants, SelectableView, SidebarLayout, Survey, SurveyEditView, SurveyShowView, SurveyView, Surveys, User, Users, helper, partial,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  StackMob.init({
    appName: "mkampus2",
    clientSubdomain: "mobilefactorysa",
    apiVersion: 1
  });

  moment.lang('pl');

  (function(String) {
    var templateCache, _base;
    (_base = String.prototype).startsWith || (_base.startsWith = function(str) {
      return this.indexOf(str) === 0;
    });
    templateCache = {};
    String.prototype.template = function() {
      return templateCache[this] || (templateCache[this] = Handlebars.compile(this));
    };
    String.prototype.render = function(data) {
      var templateData;
      templateData = _.extend(_.clone(window.globals), data);
      return this.template()(templateData);
    };
    String.prototype.toURL = function() {
      return encodeURIComponent(this);
    };
    return String.prototype.fromURL = function() {
      return decodeURIComponent(this);
    };
  })(String);

  partial = function(sources) {
    var name, source, _results;
    _results = [];
    for (name in sources) {
      source = sources[name];
      _results.push(Handlebars.registerPartial(name, source));
    }
    return _results;
  };

  helper = function(helpers) {
    var fn, name, _results;
    _results = [];
    for (name in helpers) {
      fn = helpers[name];
      _results.push(Handlebars.registerHelper(name, fn));
    }
    return _results;
  };

  partial({
    navbar: "<div class=\"navbar navbar-fixed-top\">\n  <div class=\"navbar-inner\">\n    <div class=\"container\">\n      <a class=\"btn btn-navbar\" data-toggle=\"collapse\" data-target=\".nav-collapse\">\n        <span class=\"icon-bar\"></span>\n        <span class=\"icon-bar\"></span>\n        <span class=\"icon-bar\"></span>\n      </a>\n      <div class=\"nav-collapse collapse\">\n        <ul class=\"nav\">\n          {{#links}}\n            <li {{#if active}}class=\"active\"{{/if}}>\n              <a class=\"link\" href=\"{{href}}\">{{label}}</a>\n            </li>\n          {{/links}}\n        </ul>\n        <ul class=\"nav pull-right\">\n          {{#if current_user }}\n            <li>\n              <a href=\"/\">\n                <i class=\"icon-off icon-white\"></i>\n                Wyloguj ( {{ current_user }} )\n              </a>\n            </li>\n          {{/if}}\n        </ul>\n      </div>\n    </div>\n  </div>\n</div>"
  });

  helper({
    if_eq: function(context, options) {
      if (context === options.hash.compare) {
        return options.fn(context);
      } else {
        return options.inverse(context);
      }
    }
  });

  helper({
    restaurantNavbar: function(context) {
      return "{{> navbar}}".render({
        links: [
          {
            href: '#',
            label: 'Restauracja',
            active: true
          }
        ]
      });
    }
  });

  helper({
    navbar: function(context) {
      return "{{> navbar}}".render({
        links: [
          {
            href: '#/notifications',
            label: 'Powiadomienia'
          }, {
            href: '#/surveys',
            label: 'Ankiety'
          }, {
            href: '#/informations',
            label: 'Informacje'
          }, {
            href: '#/map',
            label: 'Mapa'
          }, {
            href: '#/restaurants',
            label: 'Restauracje'
          }, {
            href: '#/contact',
            label: 'Kontakt'
          }
        ]
      });
    }
  });

  partial({
    footer: "<footer class=\"hidden-phone\">\n  <img src=\"/img/logo.png\" />\n</footer>"
  });

  helper({
    footer: function() {
      return "{{> footer}}".render();
    }
  });

  helper({
    header: function(title, options) {
      return "<header>\n  <div class=\"container list-view\">\n    <div class=\"row\">\n      <div class=\"span4 category\">\n        <h1>{{title}}</h1>\n      </div>\n      \n      <div class=\"span8 add-section\">\n        {{{add_section}}}\n      </div>\n    </div>\n  </div>\n</header>".render({
        title: title,
        add_section: options.fn(this)
      });
    }
  });

  helper({
    items: function(id) {
      return "<div class=\"container\">\n  <section>\n  <div class=\"row\" id=\"{{id}}\">\n    ...\n  </div>\n  </section>\n</div>".render({
        id: id
      });
    }
  });

  helper({
    layout: function(options) {
      return "{{{navbar}}}\n{{{content}}}\n{{{footer}}}".render({
        content: options.fn(this)
      });
    }
  });

  helper({
    timeHuman: function(time) {
      var timestamp;
      timestamp = moment(time);
      return timestamp.format('LLL');
    }
  });

  helper({
    timeAgo: function(time) {
      var timestamp;
      timestamp = moment(time);
      return timestamp.fromNow();
    }
  });

  helper({
    timeSwitch: function(time) {
      return "<span class=\"hover-switch\">\n  <span class=\"hover-on\">{{ timeHuman time }}</span>\n  <span class=\"hover-off\">{{ timeAgo time }}</span>\n</span>".render({
        time: time
      });
    }
  });

  User = (function(_super) {

    __extends(User, _super);

    User.name = 'User';

    function User() {
      return User.__super__.constructor.apply(this, arguments);
    }

    return User;

  })(StackMob.User);

  Users = (function(_super) {

    __extends(Users, _super);

    Users.name = 'Users';

    function Users() {
      return Users.__super__.constructor.apply(this, arguments);
    }

    Users.prototype.model = User;

    return Users;

  })(StackMob.Collection);

  LoginView = (function(_super) {

    __extends(LoginView, _super);

    LoginView.name = 'LoginView';

    function LoginView() {
      this.submit = __bind(this.submit, this);
      return LoginView.__super__.constructor.apply(this, arguments);
    }

    LoginView.prototype.template = "<div class=\"container\" id=\"login\">\n  <form action=\"POST\" class=\"form-horizontal\">\n  <div class=\"modal\" style=\"position: relative; top: auto; left: auto; margin: 0 auto; z-index: 1; max-width: 100%;\">\n    <div class=\"modal-header\">\n      <h3>Uniwersytet Ekonomiczny we Wrocławiu</h3>\n    </div>\n    <div class=\"modal-body\">\n        <fieldset>\n\n          <div class=\"control-group\">\n            <label for=\"login-input\" class=\"control-label\">Login</label>\n            <div class=\"controls\"><input type=\"text\" id=\"login-input\" class=\"input-xlarge\" autofocus /></div>\n          </div>\n          <div class=\"control-group\">\n            <label for=\"password-input\" class=\"control-label\">Hasło</label>\n            <div class=\"controls\"><input type=\"password\" id=\"password-input\" class=\"input-xlarge\" /></div>\n          </div>\n        </fieldset>\n\n    </div>\n    <div class=\"modal-footer\">\n      <input id=\"login-button\" type=\"submit\" class=\"btn btn-big btn-primary\" value=\"Zaloguj\" />\n    </div>\n  </div>\n  </form>\n  {{{ footer }}}\n</div>";

    LoginView.prototype.events = {
      submit: 'submit'
    };

    LoginView.prototype.submit = function(e) {
      var user,
        _this = this;
      console.log("submited");
      e.preventDefault();
      $('#login-button').button('toggle');
      user = new User({
        username: this.$('#login-input').val(),
        password: this.$('#password-input').val()
      });
      return user.login(false, {
        success: function(u) {
          return _this.trigger('login', user);
        },
        error: function(u, e) {
          _this.$('.control-group').addClass('error');
          return $('#login-button').button('toggle');
        }
      });
    };

    LoginView.prototype.render = function() {
      this.$el.html(this.template.render());
      this.$('#login-input').focus();
      return this;
    };

    return LoginView;

  })(Backbone.View);

  LoadableCollection = (function(_super) {

    __extends(LoadableCollection, _super);

    LoadableCollection.name = 'LoadableCollection';

    function LoadableCollection() {
      return LoadableCollection.__super__.constructor.apply(this, arguments);
    }

    LoadableCollection.prototype.load = function() {
      var _this = this;
      if (this.fetchPromise == null) {
        this.fetchPromise = $.Deferred();
        this.fetch({
          success: function() {
            return _this.fetchPromise.resolve(_this);
          }
        });
      }
      return this.fetchPromise;
    };

    return LoadableCollection;

  })(StackMob.Collection);

  CollectionView = (function(_super) {

    __extends(CollectionView, _super);

    CollectionView.name = 'CollectionView';

    function CollectionView() {
      this.addOne = __bind(this.addOne, this);

      this.addAll = __bind(this.addAll, this);
      return CollectionView.__super__.constructor.apply(this, arguments);
    }

    CollectionView.prototype.initialize = function() {
      var _this = this;
      console.log('CollectionView initialized');
      this.itemView || (this.itemView = this.options.itemView);
      return $.when(this.collection).then(function(collection) {
        console.log('collection', collection);
        collection.on('reset', _this.addAll);
        collection.on('add', _this.addAll);
        return collection.on('remove', _this.addAll);
      });
    };

    CollectionView.prototype.addAll = function() {
      var $collection,
        _this = this;
      $collection = this.$collection || this.$el;
      console.log('$collection', $collection);
      return $.when(this.collection).then(function(collection) {
        console.log('CollectionView addAll from collection', collection, collection.length, _this.itemView);
        $collection.empty();
        return collection.each(_this.addOne);
      });
    };

    CollectionView.prototype.addOne = function(model) {
      var $collection, options, view;
      options = _.extend(_.clone(this.options), {
        model: model,
        collection: this.collection
      });
      view = new this.itemView(options);
      console.log('view', view);
      $collection = this.$collection || this.$el;
      if (this.options.prepend != null) {
        $collection.prepend(view.render().el);
      } else {
        $collection.append(view.render().el);
      }
      return console.log('view.el', view.el);
    };

    CollectionView.prototype.render = function() {
      console.log('CollectionView rendered', this);
      this.addAll();
      return this;
    };

    return CollectionView;

  })(Backbone.View);

  AddView = (function(_super) {

    __extends(AddView, _super);

    AddView.name = 'AddView';

    function AddView() {
      return AddView.__super__.constructor.apply(this, arguments);
    }

    AddView.prototype.template = "<input type=\"text\" class=\"add\" placeholder=\"{{ placeholder }}\"/>";

    AddView.prototype.events = {
      'click input': 'add'
    };

    AddView.prototype.add = function(event) {
      this.collection.trigger('new');
      return this.trigger('click');
    };

    AddView.prototype.getPlaceholder = function() {
      return this.options.placeholder || "Dodaj";
    };

    AddView.prototype.render = function() {
      this.$el.html(this.template.render({
        placeholder: this.getPlaceholder()
      }));
      return this;
    };

    return AddView;

  })(Backbone.View);

  MenuLayout = (function(_super) {

    __extends(MenuLayout, _super);

    MenuLayout.name = 'MenuLayout';

    function MenuLayout() {
      return MenuLayout.__super__.constructor.apply(this, arguments);
    }

    MenuLayout.prototype.template = "{{#layout}}\n  <header>\n    <div class=\"container list-view\">\n      <div class=\"row\">\n        <div class=\"span4 category\">\n          <h1>{{ title }}</h1>\n        </div>\n        <div class=\"span8 add-section\">\n        </div>\n      </div>\n    </div>\n  </header>\n  <div class=\"container\">\n    <section>\n      <div class=\"row menu\">\n        <div class=\"span12 empty\">...</div>\n      </div>\n    </section>\n  </div>\n{{/layout}}";

    MenuLayout.prototype.render = function() {
      var $addSection, $list, addView, collection, listView, title;
      collection = this.collection;
      title = this.title || this.options.title;
      addView = this.addView || this.options.addView;
      listView = this.listView || this.options.listView;
      this.$el.html(this.template.render({
        title: title
      }));
      $addSection = this.$('.add-section');
      $list = this.$('.menu');
      addView.setElement($addSection);
      listView.setElement($list);
      addView.render();
      listView.render();
      return this;
    };

    return MenuLayout;

  })(Backbone.View);

  SidebarLayout = (function(_super) {

    __extends(SidebarLayout, _super);

    SidebarLayout.name = 'SidebarLayout';

    function SidebarLayout() {
      return SidebarLayout.__super__.constructor.apply(this, arguments);
    }

    SidebarLayout.prototype.template = "{{#layout}}\n  <div class=\"container item-view\">\n    <div class=\"row\">\n      <div class=\"span4\">\n        <div class=\"category\">\n          <a href=\"{{ backLink }}\"><h1>{{ title }}</h1></a>\n        </div>\n        <div class=\"row hidden-phone menu\">\n        </div>\n      </div>\n      <div class=\"span8 main\">\n      </div>\n    </div>\n  </div>\n{{/layout}}";

    SidebarLayout.prototype.render = function() {
      var $main, $menu, backLink, listView, mainView, title;
      title = this.title || this.options.title;
      backLink = this.backLink || this.options.backLink;
      mainView = this.mainView || this.options.mainView;
      listView = this.listView || this.options.listView;
      this.$el.html(this.template.render({
        title: title,
        backLink: backLink
      }));
      $main = this.$('.main');
      $menu = this.$('.menu');
      mainView.setElement($main);
      mainView.render();
      listView.setElement($menu);
      listView.render();
      return this;
    };

    return SidebarLayout;

  })(Backbone.View);

  Notification = (function(_super) {

    __extends(Notification, _super);

    Notification.name = 'Notification';

    function Notification() {
      return Notification.__super__.constructor.apply(this, arguments);
    }

    Notification.prototype.schemaName = 'notification';

    Notification.maxLength = 200;

    Notification.maxDisplayLength = 100;

    return Notification;

  })(StackMob.Model);

  Notifications = (function(_super) {

    __extends(Notifications, _super);

    Notifications.name = 'Notifications';

    function Notifications() {
      return Notifications.__super__.constructor.apply(this, arguments);
    }

    Notifications.prototype.model = Notification;

    return Notifications;

  })(StackMob.Collection);

  NotificationView = (function(_super) {

    __extends(NotificationView, _super);

    NotificationView.name = 'NotificationView';

    function NotificationView() {
      return NotificationView.__super__.constructor.apply(this, arguments);
    }

    NotificationView.prototype.className = 'notification span4';

    NotificationView.prototype.template = "<p class=\"date\">{{{ timeSwitch createddate }}}</p>\n<p class=\"content\">{{ content }}</p>";

    NotificationView.prototype.render = function() {
      this.$el.html(this.template.render(this.model.toJSON()));
      return this;
    };

    return NotificationView;

  })(Backbone.View);

  NotificationsView = (function(_super) {

    __extends(NotificationsView, _super);

    NotificationsView.name = 'NotificationsView';

    function NotificationsView() {
      this.reset = __bind(this.reset, this);
      return NotificationsView.__super__.constructor.apply(this, arguments);
    }

    NotificationsView.prototype.itemView = NotificationView;

    NotificationsView.prototype.template = "{{#layout}}\n  {{#header \"Powiadomienia\"}}\n    <form action=\"\" id=\"new-notification-form\" class=\"editable\">\n      <textarea name=\"\" id=\"new-notification-input\" rows=\"1\" class=\"add\" placeholder=\"Treść nowego powiadomienia\"></textarea>\n      <div class=\"form-actions edit\">\n        <div class=\"row-fluid\">\n          <div class=\"span6\">\n            <div class=\"progress\" id=\"new-notification-progress\">\n              <div id=\"new-notification-bar\" class=\"bar\" style=\"width: 0%;\"></div>\n            </div>\n          </div>\n          <div class=\"span6\">\n            <button type=\"submit\" id=\"new-notification-submit\" data-loading-text=\"Wysyłam...\" class=\"btn btn-primary btn-large pull-right\">\n              <i class=\"icon-ok icon-white\"></i>\n              Wyślij\n            </button>\n            <!-- <input type=\"submit\" id=\"new-notification-submit\" data-loading-text=\"Wysyłam...\" class=\"btn btn-primary btn-large pull-right\" value=\"Wyślij\" /> -->\n          </div>\n        </div>\n      </div>\n    </form>\n  {{/header}}\n  {{{items \"notifications\"}}}\n{{/layout}}";

    NotificationsView.prototype.events = {
      'focus #new-notification-input': 'edit',
      'blur #new-notification-input': 'show',
      'keyup #new-notification-input': 'update',
      'submit #new-notification-form': 'submit'
    };

    NotificationsView.prototype.initialize = function() {
      this.options.prepend = true;
      return NotificationsView.__super__.initialize.apply(this, arguments);
    };

    NotificationsView.prototype.edit = function() {
      this.$editable.addClass('active');
      return this.$input.attr('rows', 4);
    };

    NotificationsView.prototype.show = function() {
      if (this.$input.val().length > 0) {
        return;
      }
      this.$editable.removeClass('active');
      return this.$input.attr('rows', 1);
    };

    NotificationsView.prototype.update = function() {
      var barClass, letters, max, percent;
      max = Notification.maxLength;
      letters = this.$input.val().length;
      percent = letters / max * 100;
      barClass = letters <= Notification.maxDisplayLength ? 'progress-success' : percent <= 100 ? 'progress-warning' : 'progress-danger';
      this.$submit.toggleClass('disabled', percent > 100 || letters === 0);
      if (percent > 100) {
        percent = 100;
      }
      this.$bar.attr('style', "width: " + percent + "%;");
      return this.$progress.attr('class', "progress " + barClass);
    };

    NotificationsView.prototype.reset = function() {
      this.$input.val('');
      this.update();
      this.$submit.button('reset');
      return this.show();
    };

    NotificationsView.prototype.submit = function(e) {
      var content,
        _this = this;
      e.preventDefault();
      content = this.$input.val();
      if (content.length < 0 || content.length > Notification.maxLength) {
        return;
      }
      this.$submit.button('loading');
      return StackMob.customcode('broadcast', {
        content: content
      }, {
        success: function() {
          console.log('broadcast sent');
          return _this.collection.create({
            content: content
          }, {
            wait: true,
            success: function() {
              return _this.reset();
            },
            failure: function() {
              alert('Powiadomienie wysłano, ale nastąpił problem z bazą danych w wyniku czego nie pojawi się na liście. Przepraszamy.');
              return _this.reset();
            }
          });
        },
        error: function() {
          alert('Błąd podczas wysyłania powiadomienia. Spróbuj ponownie później.');
          return _this.$submit.button('reset');
        }
      });
    };

    NotificationsView.prototype.render = function() {
      this.$el.html(this.template.render());
      this.$input = this.$('#new-notification-input');
      this.$progress = this.$('#new-notification-progress');
      this.$bar = this.$('#new-notification-bar');
      this.$submit = this.$('#new-notification-submit');
      this.$editable = this.$('.editable');
      this.$collection = this.$('#notifications');
      NotificationsView.__super__.render.apply(this, arguments);
      this.update();
      return this;
    };

    return NotificationsView;

  })(CollectionView);

  Survey = (function(_super) {

    __extends(Survey, _super);

    Survey.name = 'Survey';

    function Survey() {
      this.saveQuestions = __bind(this.saveQuestions, this);
      return Survey.__super__.constructor.apply(this, arguments);
    }

    Survey.prototype.schemaName = 'survey';

    Survey.prototype.defaults = function() {
      return {
        title: ''
      };
    };

    Survey.prototype.validate = function(_arg) {
      var title;
      title = _arg.title;
      console.log('survey validation, title:', title);
      if (title.length < 1) {
        return "Ankieta musi mieć tytuł";
      }
      return null;
    };

    Survey.prototype.initialize = function() {
      return this.on('sync', this.saveQuestions);
    };

    Survey.prototype.saveQuestions = function() {
      var _this = this;
      return this.questions.each(function(model) {
        return model.save({
          survey: _this.id
        });
      });
    };

    Survey.prototype.getQuestions = function() {
      var fetchMyQuestions,
        _this = this;
      if (this.fetchQuestionsPromise == null) {
        this.fetchQuestionsPromise = $.Deferred();
        this.questions = new Questions();
        if (this.id != null) {
          fetchMyQuestions = new StackMob.Collection.Query();
          fetchMyQuestions.equals('survey', this.id);
          this.questions.query(fetchMyQuestions);
          this.questions.on('reset', function() {
            return _this.fetchQuestionsPromise.resolve(_this.questions);
          });
        } else {
          this.fetchQuestionsPromise.resolve(this.questions);
        }
      }
      return this.fetchQuestionsPromise;
    };

    return Survey;

  })(StackMob.Model);

  Surveys = (function(_super) {

    __extends(Surveys, _super);

    Surveys.name = 'Surveys';

    function Surveys() {
      return Surveys.__super__.constructor.apply(this, arguments);
    }

    Surveys.prototype.model = Survey;

    Surveys.prototype.comparator = function(survey) {
      return -survey.get('createddate');
    };

    return Surveys;

  })(LoadableCollection);

  Question = (function(_super) {

    __extends(Question, _super);

    Question.name = 'Question';

    function Question() {
      return Question.__super__.constructor.apply(this, arguments);
    }

    Question.prototype.schemaName = 'question';

    Question.prototype.validate = function(attrs) {};

    Question.prototype.defaults = {
      type: "1",
      content: '',
      answers: ''
    };

    return Question;

  })(StackMob.Model);

  Questions = (function(_super) {

    __extends(Questions, _super);

    Questions.name = 'Questions';

    function Questions() {
      return Questions.__super__.constructor.apply(this, arguments);
    }

    Questions.prototype.model = Question;

    return Questions;

  })(StackMob.Collection);

  SurveyView = (function(_super) {

    __extends(SurveyView, _super);

    SurveyView.name = 'SurveyView';

    function SurveyView() {
      this.render = __bind(this.render, this);

      this.onSelect = __bind(this.onSelect, this);
      return SurveyView.__super__.constructor.apply(this, arguments);
    }

    SurveyView.prototype.template = "<div class=\"survey selectable span4 {{#if active}}active{{/if}}\">\n  <p class=\"date\">{{{ timeSwitch createddate }}}</p>\n  <p class=\"content\">\n    {{#if survey_id}}\n    {{else}}\n      {{#if active}}\n        <i class=\"icon-pencil icon-white\"></i>\n      {{else}}\n        <i class=\"icon-pencil\"></i>\n      {{/if}}\n      \n    {{/if}}\n    {{ title }}\n  </p>\n</div>";

    SurveyView.prototype.events = {
      'click': 'select'
    };

    SurveyView.prototype.initialize = function() {
      this.model.on('change', this.render);
      return this.collection.on('show', this.onSelect);
    };

    SurveyView.prototype.onSelect = function() {
      return this.render();
    };

    SurveyView.prototype.select = function() {
      return this.collection.trigger('show', this.model);
    };

    SurveyView.prototype.render = function() {
      var _this = this;
      $.when(this.collection).then(function(collection) {
        var active;
        active = collection.active && ((_this.model.id && collection.active.id === _this.model.id) || (collection.active.cid === _this.model.cid));
        _this.$el.html(_this.template.render(_.extend(_this.model.toJSON(), {
          active: active
        })));
        return console.log('render survey view', collection.active);
      });
      return this;
    };

    return SurveyView;

  })(Backbone.View);

  QuestionEditView = (function(_super) {

    __extends(QuestionEditView, _super);

    QuestionEditView.name = 'QuestionEditView';

    function QuestionEditView() {
      this.save = __bind(this.save, this);

      this.destroy = __bind(this.destroy, this);

      this.onDestroy = __bind(this.onDestroy, this);

      this.onEdit = __bind(this.onEdit, this);
      return QuestionEditView.__super__.constructor.apply(this, arguments);
    }

    QuestionEditView.prototype.template = "<section class=\"editable {{#if isOpen}} active {{/if}}\">\n  \n  <div class=\"configurable show\">\n    <h3>\n      <i class=\"icon-{{icon}}\"></i>\n      {{ content }}\n    </h3>\n  </div>\n  <div class=\"row show\">\n    {{#checkAnswers}}\n      <div class=\"span4 item\">\n        <label class=\"checkbox\">\n          <input type=\"checkbox\" disabled=\"disabled\" />\n          {{ this }}\n        </label>\n      </div>\n    {{/checkAnswers}}\n    {{#radioAnswers}}\n      <div class=\"span4 item\">\n        <label class=\"radio\">\n          <input type=\"radio\" disabled=\"disabled\" />\n          {{ this }}\n        </label>\n      </div>\n    {{/radioAnswers}}\n  </div>\n  \n  <div class=\"add-section edit\">\n    <form action=\"\">\n      <input class=\"name add\" type=\"text\" autofocus=\"autofocus\" placeholder=\"Treść nowego pytania\" value=\"{{ content }}\"/>\n      <div class=\"form-actions toolbar\">\n        <div class=\"btn-group\" >\n          {{#types}}\n            <button class=\"btn {{#if active}} active {{/if}} type\" data-type=\"{{ type }}\">\n              <i class=\"icon-{{ icon }}\"></i>\n              {{ name }}\n            </button>\n          {{/types}}\n        </div>\n      </div>\n      <textarea rows=3 class=\"add answers\" placeholder=\"Jedna odpowiedź w jednej linijce\">{{ textAnswers }}</textarea>\n      <div class=\"form-actions\">\n        <button class=\"btn btn-large destroy-question\">\n          <i class=\"icon-remove\"></i>\n          Usuń pytanie\n        </button>\n        <button type=\"submit\" class=\"btn btn-primary btn-large pull-right save\">\n          <i class=\"icon-pencil icon-white\"></i>\n          Zapisz pytanie\n        </button>\n      </div>\n    </form>\n  </div>\n</section>";

    QuestionEditView.prototype.events = {
      'click .show': 'edit',
      'click .type': 'setType',
      'click .type > i': 'typeIcon',
      'submit form': 'save',
      'click .destroy-question': 'destroy'
    };

    QuestionEditView.prototype.typeIcon = function(e) {
      e.target = $(e.target).parent()[0];
      return this.setType(e);
    };

    QuestionEditView.prototype.initialize = function() {
      this.isOpen = !this.model.get('content');
      this.model.collection.on('edit', this.onEdit);
      return this.model.on('destroy', this.onDestroy);
    };

    QuestionEditView.prototype.onEdit = function(model) {
      console.log('onEdit');
      if (model === this.model) {
        return this.open();
      } else {
        console.log('edit another question');
        this.persist();
        if (this.model.get('content').length > 0) {
          console.log('has content -> save');
          return this.save();
        } else {
          console.log('no content -> destroy');
          return this.model.destroy();
        }
      }
    };

    QuestionEditView.prototype.onDestroy = function() {
      return this.remove();
    };

    QuestionEditView.prototype.destroy = function(e) {
      e.preventDefault();
      console.log(10);
      this.model.collection.trigger('close');
      return this.model.destroy();
    };

    QuestionEditView.prototype.save = function(event) {
      if (event != null) {
        if (typeof event.preventDefault === "function") {
          event.preventDefault();
        }
      }
      console.log('save');
      this.persist();
      if (this.model.get('content').length > 0) {
        console.log('has content');
        this.close();
        return this.model.collection.trigger('close');
      } else {
        console.log("doesn't have content");
        return this.render();
      }
    };

    QuestionEditView.prototype.edit = function() {
      return this.model.collection.trigger('edit', this.model);
    };

    QuestionEditView.prototype.open = function() {
      this.isOpen = true;
      return this.render();
    };

    QuestionEditView.prototype.close = function(event) {
      if (event != null) {
        if (typeof event.preventDefault === "function") {
          event.preventDefault();
        }
      }
      this.isOpen = false;
      return this.render();
    };

    QuestionEditView.prototype.setType = function(e) {
      var type;
      e.preventDefault();
      type = $(e.target).data('type');
      if (!type) {
        return;
      }
      type = type.toString();
      this.model.set({
        type: type
      });
      this.persist();
      return this.render();
    };

    QuestionEditView.prototype.persist = function() {
      var answers, name;
      name = this.$('.name').val();
      answers = this.serializeAnswers(this.$('.answers').val().split("\n"));
      return this.model.set({
        content: name,
        answers: answers
      });
    };

    QuestionEditView.prototype.focus = function() {
      return this.$name.focus();
    };

    QuestionEditView.prototype.focusOnAnswers = function() {
      return this.$answers.focus();
    };

    QuestionEditView.prototype.icons = {
      '1': 'star',
      '2': 'hand-right',
      '3': 'check',
      '4': 'comment'
    };

    QuestionEditView.prototype.serializeAnswers = function(answersArray) {
      return "[" + answersArray.join(",") + "]";
    };

    QuestionEditView.prototype.deserializeAnswers = function(answersSerialized) {
      return answersSerialized.slice(1, -1).split(',');
    };

    QuestionEditView.prototype.data = function() {
      var arrayAnswers, checkAnswers, radioAnswers, serializedAnswers, textAnswers, type, types;
      types = [
        {
          name: 'Ocena',
          type: '1',
          icon: this.icons['1']
        }, {
          name: '1 opcja',
          type: '2',
          icon: this.icons['2']
        }, {
          name: 'Wiele opcji',
          type: '3',
          icon: this.icons['3']
        }, {
          name: 'Komentarz',
          type: '4',
          icon: this.icons['4']
        }
      ];
      type = Number(this.model.get('type'));
      types[type - 1].active = true;
      serializedAnswers = this.model.get('answers');
      arrayAnswers = this.deserializeAnswers(serializedAnswers);
      textAnswers = arrayAnswers.join("\n");
      arrayAnswers = textAnswers.split("\n");
      radioAnswers = type === 2 ? arrayAnswers : void 0;
      checkAnswers = type === 3 ? arrayAnswers : void 0;
      return _.extend(this.model.toJSON(), {
        isOpen: this.isOpen,
        types: types,
        textAnswers: textAnswers,
        checkAnswers: checkAnswers,
        radioAnswers: radioAnswers,
        icon: this.icons[type]
      });
    };

    QuestionEditView.prototype.render = function() {
      var type;
      this.$el.html(this.template.render(this.data()));
      this.$name = this.$('.name');
      this.$answers = this.$('.answers');
      type = this.model.get('type');
      this.$answers.toggleClass('hidden', type !== "2" && type !== "3");
      this.$('.type').each(function() {
        return $(this).toggleClass('active', $(this).data('type').toString() === type);
      });
      if (type === "2" || type === "3") {
        this.focusOnAnswers();
      } else {
        this.focus();
      }
      return this;
    };

    return QuestionEditView;

  })(Backbone.View);

  QuestionView = (function(_super) {

    __extends(QuestionView, _super);

    QuestionView.name = 'QuestionView';

    function QuestionView() {
      return QuestionView.__super__.constructor.apply(this, arguments);
    }

    QuestionView.prototype.tagName = 'section';

    QuestionView.prototype.template = "<div class=\"item\">\n  <h3>\n    <i class=\"icon-{{icon}}\"></i>\n    {{ content }}\n  </h3>\n</div>\n<div class=\"row\">\n  {{#checkAnswers}}\n    <div class=\"span4 item\">\n      <label class=\"checkbox\">\n        <input type=\"checkbox\" disabled=\"disabled\" />\n        {{ this }}\n      </label>\n    </div>\n  {{/checkAnswers}}\n  {{#radioAnswers}}\n    <div class=\"span4 item\">\n      <label class=\"radio\">\n        <input type=\"radio\" disabled=\"disabled\" />\n        {{ this }}\n      </label>\n    </div>\n  {{/radioAnswers}}\n</div>";

    QuestionView.prototype.icons = {
      '1': 'star',
      '2': 'hand-right',
      '3': 'check',
      '4': 'comment'
    };

    QuestionView.prototype.serializeAnswers = function(answersArray) {
      return "[" + answersArray.join(",") + "]";
    };

    QuestionView.prototype.deserializeAnswers = function(answersSerialized) {
      return answersSerialized.slice(1, -1).split(',');
    };

    QuestionView.prototype.data = function() {
      var arrayAnswers, checkAnswers, radioAnswers, serializedAnswers, textAnswers, type, types;
      types = [
        {
          name: 'Ocena',
          type: '1',
          icon: this.icons['1']
        }, {
          name: 'Decyzja',
          type: '2',
          icon: this.icons['2']
        }, {
          name: 'Wiele opcji',
          type: '3',
          icon: this.icons['3']
        }, {
          name: 'Komentarz',
          type: '4',
          icon: this.icons['4']
        }
      ];
      type = Number(this.model.get('type'));
      types[type - 1].active = true;
      serializedAnswers = this.model.get('answers');
      arrayAnswers = this.deserializeAnswers(serializedAnswers);
      textAnswers = arrayAnswers.join("\n");
      radioAnswers = type === 2 ? arrayAnswers : void 0;
      checkAnswers = type === 3 ? arrayAnswers : void 0;
      return _.extend(this.model.toJSON(), {
        types: types,
        textAnswers: textAnswers,
        checkAnswers: checkAnswers,
        radioAnswers: radioAnswers,
        icon: this.icons[type]
      });
    };

    QuestionView.prototype.render = function() {
      this.$el.html(this.template.render(this.data()));
      return this;
    };

    return QuestionView;

  })(Backbone.View);

  SurveyShowView = (function(_super) {

    __extends(SurveyShowView, _super);

    SurveyShowView.name = 'SurveyShowView';

    function SurveyShowView() {
      return SurveyShowView.__super__.constructor.apply(this, arguments);
    }

    SurveyShowView.prototype.template = "<div id=\"title-show\" class=\"category\">\n  <h1 id=\"title\">{{ title }}</h1>\n</div>\n<div id=\"questions\">\n</div>";

    SurveyShowView.prototype.itemView = QuestionView;

    SurveyShowView.prototype.initialize = function() {
      this.collection = this.model.getQuestions();
      $.when(this.collection).then(function(collection) {
        return console.log('questions of survey', this.model, collection);
      });
      return SurveyShowView.__super__.initialize.apply(this, arguments);
    };

    SurveyShowView.prototype.render = function() {
      this.$el.html(this.template.render(this.model.toJSON()));
      this.$collection = this.$('#questions');
      SurveyShowView.__super__.render.apply(this, arguments);
      console.log('@$collection', this.$collection);
      return this;
    };

    return SurveyShowView;

  })(CollectionView);

  SurveyEditView = (function(_super) {

    __extends(SurveyEditView, _super);

    SurveyEditView.name = 'SurveyEditView';

    function SurveyEditView() {
      this.closeTitle = __bind(this.closeTitle, this);

      this.onClose = __bind(this.onClose, this);

      this.onEdit = __bind(this.onEdit, this);

      this.createQuestion = __bind(this.createQuestion, this);

      this.destroy = __bind(this.destroy, this);

      this.publish = __bind(this.publish, this);

      this.onSync = __bind(this.onSync, this);

      this.onSetTitle = __bind(this.onSetTitle, this);
      return SurveyEditView.__super__.constructor.apply(this, arguments);
    }

    SurveyEditView.prototype.template = "<div class=\"editable\" id=\"title-section\">\n  <div class=\"add-section edit\">\n    <form id=\"title-edit\" action=\"\">\n      <input id=\"title-input\" type=\"text\" class=\"add edit\" placeholder=\"Tytuł nowej ankiety\" autofocus=\"autofocus\" value=\"{{ title }}\"/>\n      <div class=\"form-actions\">\n        <button type=\"submit\" id=\"title-submit\" class=\"btn btn-primary btn-large pull-right\">\n          <i class=\"icon-pencil icon-white\"></i>\n          Zapisz tytuł\n        </button>\n      </div>\n    </form>\n  </div>\n\n  <div id=\"title-show\" class=\"category show\">\n    <h1 id=\"title\">{{ title }}</h1>\n  </div>\n</div>\n<div id=\"questions\">\n</div>\n<section class=\"top-level-action-block\">\n  <div>\n    <div class=\"add-section \">\n      <input type=\"text\" class=\"new-question-button add top-level-actions\" placeholder=\"Treść nowego pytania\"/>\n    </div>\n  </div>\n</section>\n<div class=\"form-actions section\">\n  <button class=\"destroy btn btn-large\">\n    <i class=\"icon-remove\"></i>\n    Usuń ankietę\n  </button>\n  \n  <button id=\"survey-submit\" class=\"btn btn-large btn-primary pull-right top-level-actions\">\n    <i class=\"icon-ok icon-white\"></i>\n    Opublikuj ankietę\n  </button>\n  \n</div>";

    SurveyEditView.prototype.itemView = QuestionEditView;

    SurveyEditView.prototype.initialize = function() {
      var _this = this;
      this.surveys = window.app.Surveys;
      this.collection = this.model.getQuestions();
      this.model.on('change:title', this.onSetTitle);
      this.model.on('sync', this.onSync);
      $.when(this.collection).then(function(collection) {
        collection.on('edit', _this.onEdit);
        return collection.on('close', _this.onClose);
      });
      return SurveyEditView.__super__.initialize.apply(this, arguments);
    };

    SurveyEditView.prototype.events = {
      'click .new-question-button': 'createQuestion',
      'submit #title-edit': 'closeTitle',
      'click #title-show': 'openTitle',
      'click .destroy': 'destroy',
      'click #survey-submit': 'publish'
    };

    SurveyEditView.prototype.onSetTitle = function() {
      var collection;
      console.log('on set ttitle');
      collection = window.app.Surveys;
      if (!collection.include(this.model)) {
        return collection.add(this.model);
      }
    };

    SurveyEditView.prototype.onSync = function() {
      return window.app.Surveys.trigger('publish', this.model);
    };

    SurveyEditView.prototype.publish = function(e) {
      if (e != null) {
        e.preventDefault();
      }
      console.log('publish');
      return this.model.save();
    };

    SurveyEditView.prototype.destroy = function(e) {
      var _this = this;
      e.preventDefault();
      console.log('destroy');
      this.model.destroy();
      return $.when(this.collection).then(function(collection) {
        collection.remove(_this.model);
        return app.navigate('/surveys', true);
      });
    };

    SurveyEditView.prototype.createQuestion = function() {
      var question,
        _this = this;
      question = new Question();
      return $.when(this.collection).then(function(collection) {
        collection.add(question);
        return collection.trigger('edit', question);
      });
    };

    SurveyEditView.prototype.onEdit = function(model) {
      if (model === this.model) {

      } else {
        this.closeTitle();
      }
      this.$('.top-level-action-block').addClass('hidden');
      return this.$('.top-level-actions').attr('disabled', 'disabled');
    };

    SurveyEditView.prototype.onClose = function() {
      this.$('.top-level-action-block').removeClass('hidden');
      return this.$('.top-level-actions').attr('disabled', false);
    };

    SurveyEditView.prototype.closeTitle = function(e) {
      var previousTitle, title,
        _this = this;
      if (e != null) {
        if (typeof e.preventDefault === "function") {
          e.preventDefault();
        }
      }
      previousTitle = this.model.get('title');
      title = this.$titleInput.val();
      if (title.length === 0) {
        return this.openTitle();
      } else {
        this.model.set({
          title: title
        });
        this.$title.html(title);
        this.$titleSection.removeClass('active');
        return $.when(this.collection).then(function(collection) {
          return collection.trigger('close');
        });
      }
    };

    SurveyEditView.prototype.openTitle = function() {
      var _this = this;
      this.$titleSection.addClass('active');
      this.$titleInput.focus();
      return $.when(this.collection).then(function(collection) {
        return collection.trigger('edit', _this.model);
      });
    };

    SurveyEditView.prototype.updateState = function() {
      var title;
      title = this.model.get('title');
      if (!title) {
        return this.openTitle();
      }
    };

    SurveyEditView.prototype.render = function() {
      this.$el.html(this.template.render(this.model.toJSON()));
      this.$collection = this.$('#questions');
      this.$newQuestionInput = this.$('#new-question');
      this.$submit = this.$('#survey-submit');
      this.$titleSection = this.$('#title-section');
      this.$title = this.$('#title');
      this.$titleInput = this.$('#title-input');
      this.$titleEdit = this.$('#title-edit');
      this.$titleShow = this.$('#title-show');
      this.$titleSubmit = this.$('#title-submit');
      this.updateState();
      SurveyEditView.__super__.render.apply(this, arguments);
      return this;
    };

    return SurveyEditView;

  })(CollectionView);

  InformationElement = (function(_super) {

    __extends(InformationElement, _super);

    InformationElement.name = 'InformationElement';

    function InformationElement() {
      return InformationElement.__super__.constructor.apply(this, arguments);
    }

    InformationElement.prototype.schemaName = 'information_element';

    InformationElement.prototype.initialize = function() {
      this.isOpen = !this.id;
      return InformationElement.__super__.initialize.apply(this, arguments);
    };

    InformationElement.prototype.defaults = {
      type: 'text'
    };

    InformationElement.prototype.parse = function(data) {
      console.log('InformationElement::parse (data)', data);
      if (typeof data === "object") {
        return data;
      } else {
        return InformationElement.__super__.parse.apply(this, arguments);
      }
    };

    return InformationElement;

  })(StackMob.Model);

  InformationElements = (function(_super) {

    __extends(InformationElements, _super);

    InformationElements.name = 'InformationElements';

    function InformationElements() {
      return InformationElements.__super__.constructor.apply(this, arguments);
    }

    InformationElements.prototype.model = InformationElement;

    InformationElements.prototype.comparator = function(model) {
      return model.get('position');
    };

    InformationElements.prototype.parse = function(response) {
      return _(response).reject(function(model) {
        return model.is_deleted;
      });
    };

    return InformationElements;

  })(StackMob.Collection);

  InformationGroup = (function(_super) {

    __extends(InformationGroup, _super);

    InformationGroup.name = 'InformationGroup';

    function InformationGroup() {
      this.saveInformations = __bind(this.saveInformations, this);
      return InformationGroup.__super__.constructor.apply(this, arguments);
    }

    InformationGroup.prototype.schemaName = 'information_group';

    InformationGroup.prototype.saveInformations = function() {
      var _this = this;
      return this.informations.each(function(model) {
        return model.save({
          survey: _this.id
        });
      });
    };

    InformationGroup.prototype.getInformations = function() {
      var fetchMyElements,
        _this = this;
      if (this.fetchElementsPromise == null) {
        this.fetchElementsPromise = $.Deferred();
        this.informations = new InformationElements();
        if (this.id != null) {
          fetchMyElements = new StackMob.Collection.Query();
          console.log('@id', this.id);
          fetchMyElements.equals('information_group', this.id);
          this.informations.query(fetchMyElements);
          console.log('waiting for reset', this.informations);
          this.informations.on('all', function(event) {
            return console.log('informations event', event);
          });
          this.informations.on('reset', function() {
            console.log('reset', _this.informations);
            return _this.fetchElementsPromise.resolve(_this.informations);
          });
        } else {
          this.fetchElementsPromise.resolve(this.informations);
        }
      }
      return this.fetchElementsPromise;
    };

    return InformationGroup;

  })(StackMob.Model);

  InformationGroups = (function(_super) {

    __extends(InformationGroups, _super);

    InformationGroups.name = 'InformationGroups';

    function InformationGroups() {
      return InformationGroups.__super__.constructor.apply(this, arguments);
    }

    InformationGroups.prototype.model = InformationGroup;

    return InformationGroups;

  })(LoadableCollection);

  SelectableView = (function(_super) {

    __extends(SelectableView, _super);

    SelectableView.name = 'SelectableView';

    function SelectableView() {
      this.render = __bind(this.render, this);

      this.triggerSelect = __bind(this.triggerSelect, this);
      return SelectableView.__super__.constructor.apply(this, arguments);
    }

    SelectableView.prototype.labelAttribute = 'name';

    SelectableView.prototype.template = function() {
      return "<div class=\"selectable span4\" data-id=\"{{ id }}\">\n  <p class=\"date\">{{{ timeSwitch createddate }}}</p>\n  <p class=\"content\">\n    {{ " + this.labelAttribute + " }}\n  </p>\n</div>";
    };

    SelectableView.prototype.initialize = function() {
      this.model.on('change', this.render);
      this.model.on('reset', this.render);
      return this.model.on('sync', this.render);
    };

    SelectableView.prototype.events = {
      'click': 'triggerSelect'
    };

    SelectableView.prototype.triggerSelect = function() {
      var _ref;
      if ((_ref = this.model) != null) {
        _ref.trigger('select', this.model);
      }
      return this.trigger('select', this.model);
    };

    SelectableView.prototype.render = function() {
      this.$el.html(this.template().render(_.extend(this.model.toJSON(), {
        id: this.model.id
      })));
      window.app.updateLinks();
      return this;
    };

    return SelectableView;

  })(Backbone.View);

  InformationGroupView = (function(_super) {

    __extends(InformationGroupView, _super);

    InformationGroupView.name = 'InformationGroupView';

    function InformationGroupView() {
      return InformationGroupView.__super__.constructor.apply(this, arguments);
    }

    return InformationGroupView;

  })(SelectableView);

  InformationElementView = (function(_super) {

    __extends(InformationElementView, _super);

    InformationElementView.name = 'InformationElementView';

    function InformationElementView() {
      return InformationElementView.__super__.constructor.apply(this, arguments);
    }

    InformationElementView.prototype.templateShow = {
      text: function() {
        return "<p>{{ text }}</p>";
      },
      title: function() {
        return "<h3>{{ title }}</h3>";
      },
      image: function() {
        return "<img src=\"{{ image }}\"/>";
      }
    };

    InformationElementView.prototype.templateEdit = {
      text: function() {
        return "<textarea class=\"text-input add\" type=\"text\" rows=\"5\" autofocus=\"autofocus\" placeholder=\"Treść nowego akapitu\">{{ text }}</textarea>";
      },
      title: function() {
        return "<input class=\"title-input add\" type=\"text\" autofocus=\"autofocus\" placeholder=\"Treść nowego tytułu\" value=\"{{ title }}\"/>";
      },
      image: function() {
        return "<img src=\"{{ image }}\"/>";
      }
    };

    InformationElementView.prototype.template = function() {
      var template;
      return "<section class=\"editable sortable {{#if isOpen}} active {{/if}}\" data-sortable-id=\"{{information_element_id}}\">\n  <div class=\"configurable show\">\n    " + ((template = this.templateShow[this.model.get('type')]) ? template() : void 0) + "\n  </div>\n  <div class=\"add-section edit\">\n    <form class=\"edit-form\" action=\"\">\n      " + ((template = this.templateEdit[this.model.get('type')]) ? template() : void 0) + "\n      <div class=\"form-actions\">\n        <button type=\"submit\" class=\"save-button btn btn-primary btn-large pull-right\">\n          <i class=\"icon-pencil icon-white\"></i>\n          Zapisz element\n        </button>\n        <button class=\"destroy-button btn btn-large\">\n          <i class=\"icon-remove\"></i>\n          Usuń element\n        </button>\n        \n      </div>\n    </form>\n  </div>\n</section>";
    };

    InformationElementView.prototype.events = {
      'click .show': 'open',
      'click .save-button': 'save',
      'submit': 'save',
      'click .destroy-button': 'destroy'
    };

    InformationElementView.prototype.initialize = function() {
      this.model.on('change', this.render, this);
      return this.model.on('sync', this.render, this);
    };

    InformationElementView.prototype.open = function() {
      this.model.isOpen = true;
      return this.render();
    };

    InformationElementView.prototype.save = function(event) {
      var type;
      event.preventDefault();
      type = this.model.get('type');
      if (type === "text") {
        this.model.set({
          text: this.$(".text-input").val()
        });
      } else if (type === "title") {
        this.model.set({
          title: this.$(".title-input").val()
        });
      }
      this.model.save();
      return this.close();
    };

    InformationElementView.prototype.destroy = function(event) {
      event.preventDefault();
      this.model.save({
        is_deleted: true
      });
      this.model.collection.remove(this.model);
      return this.remove();
    };

    InformationElementView.prototype.close = function() {
      this.model.isOpen = false;
      return this.render();
    };

    InformationElementView.prototype.render = function() {
      this.$el.html(this.template().render(_.extend(this.model.toJSON(), {
        isOpen: this.model.isOpen
      })));
      return this;
    };

    return InformationElementView;

  })(Backbone.View);

  InformationGroupShowView = (function(_super) {

    __extends(InformationGroupShowView, _super);

    InformationGroupShowView.name = 'InformationGroupShowView';

    function InformationGroupShowView() {
      return InformationGroupShowView.__super__.constructor.apply(this, arguments);
    }

    InformationGroupShowView.prototype.titlePlaceholder = "Tytuł nowego działu";

    InformationGroupShowView.prototype.labelAttribute = 'name';

    InformationGroupShowView.prototype.itemView = InformationElementView;

    InformationGroupShowView.prototype.initialize = function() {
      this.collection = this.model.getInformations();
      return InformationGroupShowView.__super__.initialize.apply(this, arguments);
    };

    InformationGroupShowView.prototype.events = {
      'click #survey-submit': 'save',
      'click .create-text': 'createText',
      'click .create-title': 'createTitle',
      'sortstop #elements': 'sort'
    };

    InformationGroupShowView.prototype.sort = function(event) {
      var _this = this;
      console.log('sort stop', event);
      return $.when(this.collection).then(function(collection) {
        return _this.$('.sortable').each(function(index, element) {
          var id;
          id = $(element).data('sortable-id');
          return collection.get(id).save({
            position: index
          });
        });
      });
    };

    InformationGroupShowView.prototype.createText = function(event) {
      var _this = this;
      event.preventDefault();
      return $.when(this.model.getInformations()).then(function(informations) {
        var newPosition;
        newPosition = _(informations.pluck('position').sort()).last() + 1;
        console.log(newPosition);
        return informations.add({
          type: 'text',
          position: newPosition,
          information_group: _this.model.id
        });
      });
    };

    InformationGroupShowView.prototype.createTitle = function(event) {
      var _this = this;
      event.preventDefault();
      return $.when(this.model.getInformations()).then(function(informations) {
        var newPosition;
        newPosition = _(informations.pluck('position').sort()).last() + 1;
        console.log(newPosition);
        return informations.add({
          type: 'title',
          position: newPosition,
          information_group: _this.model.id
        });
      });
    };

    InformationGroupShowView.prototype.persist = function() {
      return this.model.set({
        name: this.$('#title-input').val()
      });
    };

    InformationGroupShowView.prototype.save = function() {
      this.persist();
      return this.model.save();
    };

    InformationGroupShowView.prototype.template = function() {
      return "<div class=\"editable active\" id=\"title-section\">\n  <div class=\"add-section edit\">\n    <form id=\"title-edit\" action=\"\">\n      <input id=\"title-input\" type=\"text\" class=\"input-title add edit\" placeholder=\"" + this.titlePlaceholder + "\" autofocus=\"autofocus\" value=\"{{ " + this.labelAttribute + " }}\"/>\n    </form>\n  </div>\n\n  <div id=\"title-show\" class=\"category show\">\n    <h1 id=\"title\">{{ " + this.labelAttribute + " }}</h1>\n  </div>\n</div>\n\n<div id=\"elements\"></div>\n  \n<div class=\"form-actions section\">\n  \n  <div class=\"btn-toolbar pull-right\">\n    \n    <div class=\"btn-group\">\n      \n      <button class=\"create-text btn btn-large\">\n        <i class=\"icon-align-left\"></i>\n        Dodaj akapit\n      </button>\n      \n      <button class=\"btn btn-large dropdown-toggle\" data-toggle=\"dropdown\">\n        <div class=\"caret\"></div>\n      </button>\n      \n      <ul class=\"dropdown-menu\">\n        <li>\n          <a class=\"create-title\" href=\"#\"><i class=\"icon-bookmark\"></i> Dodaj tytuł</a>\n        </li>\n        <li>\n          <a class=\"create-text\" href=\"#\"><i class=\"icon-align-left\"></i> Dodaj paragraf</a>\n        </li>\n      </ul>\n    </div>\n    \n    <div class=\"btn-group\">\n      <button id=\"survey-submit\" class=\"btn btn-large btn-primary top-level-actions\">\n        <i class=\"icon-ok icon-white\"></i>\n        Zapisz\n      </button>\n    </div>\n  </div>\n  \n  <button class=\"destroy btn btn-large\">\n    <i class=\"icon-remove\"></i>\n    Usuń\n  </button>\n</div>";
    };

    InformationGroupShowView.prototype.render = function() {
      this.$el.html(this.template().render(this.model.toJSON()));
      this.$collection = this.$('#elements');
      this.$collection.sortable({});
      this.$collection.disableSelection();
      return InformationGroupShowView.__super__.render.apply(this, arguments);
    };

    return InformationGroupShowView;

  })(CollectionView);

  Place = (function(_super) {

    __extends(Place, _super);

    Place.name = 'Place';

    function Place() {
      return Place.__super__.constructor.apply(this, arguments);
    }

    Place.prototype.schemaName = 'location';

    return Place;

  })(StackMob.Model);

  Places = (function(_super) {

    __extends(Places, _super);

    Places.name = 'Places';

    function Places() {
      return Places.__super__.constructor.apply(this, arguments);
    }

    Places.prototype.model = Place;

    Places.prototype.parse = function(response) {
      return _(response).reject(function(model) {
        return model.is_deleted;
      });
    };

    return Places;

  })(LoadableCollection);

  PlaceView = (function(_super) {

    __extends(PlaceView, _super);

    PlaceView.name = 'PlaceView';

    function PlaceView() {
      return PlaceView.__super__.constructor.apply(this, arguments);
    }

    return PlaceView;

  })(SelectableView);

  PlaceShowView = (function(_super) {

    __extends(PlaceShowView, _super);

    PlaceShowView.name = 'PlaceShowView';

    function PlaceShowView() {
      this.render = __bind(this.render, this);

      this.destroy = __bind(this.destroy, this);

      this.save = __bind(this.save, this);
      return PlaceShowView.__super__.constructor.apply(this, arguments);
    }

    PlaceShowView.prototype.labelAttribute = 'name';

    PlaceShowView.prototype.titlePlaceholder = 'Nazwa nowego miejsca';

    PlaceShowView.prototype.template = function() {
      return "<div id=\"title-section\">\n  <div class=\"add-section\">\n    <form id=\"title-edit\" action=\"\">\n      <input type=\"text\" class=\"input-title add edit\" placeholder=\"" + this.titlePlaceholder + "\" autofocus=\"autofocus\" value=\"{{ " + this.labelAttribute + " }}\"/>\n    </form>\n  </div>\n</div>\n\n<div id=\"elements\">\n</div>\n\n<section class=\"item\">\n  <form action=\"#\" class=\"form-horizontal\">\n    <div class=\"row-fluid\">\n      <div class=\"span12\">\n        <div class=\"control-group\">\n          <label for=\"\" class=\"control-label\">Opis</label>\n          <div class=\"controls\"><textarea class=\"span12 input-description\">{{ description }}</textarea></div>\n        </div>\n        <div class=\"control-group\">\n          <label for=\"\" class=\"control-label\">Szerokość geograficzna</label>\n          <div class=\"controls\"><input type=\"text\" class=\"span6 input-latitude\" value=\"{{ latitude }}\" placeholder=\"51.110195\"/></div>\n        </div>\n        <div class=\"control-group\">\n          <label for=\"\" class=\"control-label\">Długość geograficzna</label>\n          <div class=\"controls\"><input type=\"text\" class=\"span6 input-longitude\" value=\"{{ longitude }}\" placeholder=\"17.031404\"/></div>\n        </div>\n      </div>\n    </div>\n    \n  </form>\n</section>\n\n\n<div id=\"elements\"></div>\n  \n<div class=\"form-actions section\">\n  \n  <button class=\"destroy btn btn-large\">\n    <i class=\"icon-remove\"></i>\n    Usuń\n  </button>\n  \n  <button class=\"save btn btn-large btn-primary pull-right\">\n    <i class=\"icon-ok icon-white\"></i>\n    Zapisz\n  </button>\n</div>";
    };

    PlaceShowView.prototype.events = {
      'click .save': 'save',
      'click .destroy': 'destroy'
    };

    PlaceShowView.prototype.initialize = function() {
      this.model.on('change', this.render);
      return this.model.on('reset', this.render);
    };

    PlaceShowView.prototype.save = function(e) {
      var attributes;
      e.preventDefault();
      console.log('save');
      attributes = {
        name: this.$('.input-title').val(),
        description: this.$('.input-description').val(),
        latitude: Number(this.$('.input-latitude').val()),
        longitude: Number(this.$('.input-longitude').val())
      };
      this.model.set(attributes);
      return this.trigger('save', this.model);
    };

    PlaceShowView.prototype.destroy = function(e) {
      e.preventDefault();
      console.log('destroy');
      this.model.set({
        is_deleted: true
      });
      return this.trigger('destroy', this.model);
    };

    PlaceShowView.prototype.render = function() {
      this.$el.html(this.template().render(this.model.toJSON()));
      return this;
    };

    return PlaceShowView;

  })(Backbone.View);

  RestaurantUser = (function(_super) {

    __extends(RestaurantUser, _super);

    RestaurantUser.name = 'RestaurantUser';

    function RestaurantUser() {
      return RestaurantUser.__super__.constructor.apply(this, arguments);
    }

    RestaurantUser.prototype.defaults = {
      role: "restaurant"
    };

    RestaurantUser.prototype.validate = function(attrs) {
      if (attrs.role !== "restaurant") {
        return "role: restaurant";
      }
      if (attrs.username === "new") {
        return "Nazwa new zabroniona";
      }
    };

    return RestaurantUser;

  })(StackMob.User);

  RestaurantUsers = (function(_super) {

    __extends(RestaurantUsers, _super);

    RestaurantUsers.name = 'RestaurantUsers';

    function RestaurantUsers() {
      return RestaurantUsers.__super__.constructor.apply(this, arguments);
    }

    RestaurantUsers.prototype.model = RestaurantUser;

    RestaurantUsers.prototype.parse = function(response) {
      return _(response).reject(function(model) {
        return model.is_deleted || model.role !== "restaurant";
      });
    };

    return RestaurantUsers;

  })(LoadableCollection);

  RestaurantUserView = (function(_super) {

    __extends(RestaurantUserView, _super);

    RestaurantUserView.name = 'RestaurantUserView';

    function RestaurantUserView() {
      return RestaurantUserView.__super__.constructor.apply(this, arguments);
    }

    RestaurantUserView.prototype.labelAttribute = 'username';

    return RestaurantUserView;

  })(SelectableView);

  RestaurantUserShowView = (function(_super) {

    __extends(RestaurantUserShowView, _super);

    RestaurantUserShowView.name = 'RestaurantUserShowView';

    function RestaurantUserShowView() {
      this.render = __bind(this.render, this);

      this.destroy = __bind(this.destroy, this);

      this.save = __bind(this.save, this);

      this.updateName = __bind(this.updateName, this);
      return RestaurantUserShowView.__super__.constructor.apply(this, arguments);
    }

    RestaurantUserShowView.prototype.labelAttribute = 'username';

    RestaurantUserShowView.prototype.titlePlaceholder = 'Nazwa nowej restauracji';

    RestaurantUserShowView.prototype.template = function() {
      return "<div id=\"title-section\">\n  <div class=\"add-section\">\n    <input type=\"text\" class=\"input-title add edit\" {{#if " + this.labelAttribute + " }}disabled{{/if}} placeholder=\"" + this.titlePlaceholder + "\" autofocus=\"autofocus\" value=\"{{ " + this.labelAttribute + " }}\"/>\n  </div>\n</div>\n\n<section class=\"item row-fluid\">\n  <div class=\"span12 form-horizontal\">\n    <legend>\n      Dedykowany użytkownik\n      <small>mogący aktualizować dane teleadresowe i menu restauracji</small>\n    </legend>\n    <div class=\"control-group\">\n      <label for=\"\" class=\"control-label\">Identyfikator</label>\n      <div class=\"controls\"><input type=\"text\" disabled class=\"span12 input-username\" value=\"{{ " + this.labelAttribute + " }}\"/></div>\n    </div>\n    \n    <div class=\"control-group\">\n      <label for=\"\" class=\"control-label\">Hasło</label>\n      <div class=\"controls\"><input type=\"password\" class=\"span12 input-password\"/></div>\n    </div>\n  \n    <div class=\"control-group\">\n      <label for=\"\" class=\"control-label\">Hasło ponownie</label>\n      <div class=\"controls\"><input type=\"password\" class=\"span12 input-password-confirmation\"/></div>\n    </div>\n    \n    \n  </div>\n</section>\n  \n<div class=\"form-actions section\">\n  \n  <button class=\"destroy btn btn-large\">\n    <i class=\"icon-remove\"></i>\n    Usuń\n  </button>\n  \n  <button class=\"save btn btn-large btn-primary pull-right\">\n    <i class=\"icon-ok icon-white\"></i>\n    Zapisz\n  </button>\n</div>";
    };

    RestaurantUserShowView.prototype.events = {
      'click .save': 'save',
      'click .destroy': 'destroy',
      'keyup .input-title': 'updateName'
    };

    RestaurantUserShowView.prototype.initialize = function(_arg) {
      this.user = _arg.user;
      this.model.on('change', this.render);
      return this.model.on('reset', this.render);
    };

    RestaurantUserShowView.prototype.updateName = function(e) {
      return this.$('.input-username').val(this.$('.input-title').val());
    };

    RestaurantUserShowView.prototype.save = function(e) {
      var password, passwordConfirmation, username;
      e.preventDefault();
      console.log('save');
      if (this.model.isNew()) {
        username = this.$('.input-title').val();
        if (!username) {
          alert('Musisz podać nazwę restauracji');
          this.$('.input-title').focus();
          return;
        }
      } else {
        username = this.model.get('username');
      }
      password = this.$('.input-password').val();
      if (!password) {
        alert('Musisz podać hasło użytkownika');
        this.$('.input-password').focus();
        return;
      }
      passwordConfirmation = this.$('.input-password-confirmation').val();
      if (password !== passwordConfirmation) {
        alert('Oba hasła muszą być jednakowe');
        this.$('.input-password-confirmation').focus();
        return;
      }
      this.model.set({
        username: username,
        password: password
      });
      return this.trigger('save', this.model, username, password);
    };

    RestaurantUserShowView.prototype.destroy = function(e) {
      e.preventDefault();
      console.log('destroy');
      return this.trigger('destroy', this.model);
    };

    RestaurantUserShowView.prototype.render = function() {
      this.$el.html(this.template().render(this.model.toJSON()));
      return this;
    };

    return RestaurantUserShowView;

  })(Backbone.View);

  App = (function(_super) {

    __extends(App, _super);

    App.name = 'App';

    function App() {
      this.updateLinks = __bind(this.updateLinks, this);

      this.restaurants = __bind(this.restaurants, this);

      this.map = __bind(this.map, this);

      this.informations = __bind(this.informations, this);

      this.showSurveyById = __bind(this.showSurveyById, this);

      this.showSurvey = __bind(this.showSurvey, this);

      this.onSelectSurvey = __bind(this.onSelectSurvey, this);
      return App.__super__.constructor.apply(this, arguments);
    }

    App.prototype.routes = {
      '': 'index',
      'notifications': 'notifications',
      'surveys': 'surveys',
      'surveys/new': 'newSurvey',
      'surveys/:id': 'showSurveyById',
      'informations': 'informations',
      'informations/:id': 'informations',
      'map': 'map',
      'map/:id': 'map',
      'restaurants': 'restaurants',
      'restaurants/:id*': 'restaurants'
    };

    App.prototype.initialize = function() {
      var _this = this;
      this.on('all', this.updateLinks);
      this.$main = $('body');
      this.Notifications = new Notifications();
      this.Surveys = new Surveys();
      this.Surveys.on('new', function() {
        return _this.navigate('/surveys/new', true);
      });
      this.Surveys.on('show', this.onSelectSurvey);
      this.Surveys.on('publish', function(model) {
        _this.Surveys.add(model);
        return _this.navigate("/surveys/" + model.id, true);
      });
      this.InformationGroups = new InformationGroups();
      this.InformationGroups.on('select', function(model) {
        return _this.navigate("/informations/" + model.id, true);
      });
      this.Places = new Places();
      this.Places.on('select', function(model) {
        return _this.navigate("/map/" + model.id, true);
      });
      this.RestaurantUsers = new RestaurantUsers();
      return this.RestaurantUsers.on('select', function(model) {
        return _this.navigate("/restaurants/" + model.id, true);
      });
    };

    App.prototype.onSelectSurvey = function(model) {
      this.Surveys.active = model;
      this.navigate("/surveys/" + (model.id || model.cid));
      return this.showSurvey(model);
    };

    App.prototype.setView = function(view) {
      this.$main.html(view.render().el);
      return this.updateLinks();
    };

    App.prototype.notifications = function() {
      this.setView(new NotificationsView({
        collection: this.Notifications
      }));
      return this.Notifications.fetch();
    };

    App.prototype.surveys = function() {
      var addView, collection, listView, view;
      collection = this.Surveys;
      collection.active = null;
      listView = new CollectionView({
        collection: collection,
        itemView: SurveyView
      });
      addView = new AddView({
        collection: collection,
        placeholder: 'Tytuł nowej ankiety'
      });
      view = new MenuLayout({
        title: 'Ankiety',
        listView: listView,
        addView: addView
      });
      this.setView(view);
      return collection.load();
    };

    App.prototype.newSurvey = function() {
      var collection, listView, mainView, model, view;
      model = new Survey();
      collection = this.Surveys;
      collection.active = model;
      mainView = new SurveyEditView({
        model: model
      });
      listView = new CollectionView({
        collection: collection,
        itemView: SurveyView,
        active: model
      });
      view = new SidebarLayout({
        title: 'Ankiety',
        backLink: '#/surveys',
        mainView: mainView,
        listView: listView
      });
      this.setView(view);
      collection.load();
      return mainView.openTitle();
    };

    App.prototype.showSurvey = function(model) {
      var collection, listView, mainView, view;
      window.model = model;
      collection = this.Surveys;
      console.log('showSurvey', model);
      mainView = model.id != null ? new SurveyShowView({
        model: model
      }) : new SurveyEditView({
        model: model
      });
      listView = new CollectionView({
        collection: collection,
        itemView: SurveyView
      });
      view = new SidebarLayout({
        title: 'Ankiety',
        backLink: '#/surveys',
        mainView: mainView,
        listView: listView
      });
      return this.setView(view);
    };

    App.prototype.showSurveyById = function(id) {
      var _this = this;
      console.log('showSurveyById', id);
      return $.when(this.Surveys.load()).then(function(collection) {
        var model;
        model = collection.get(id) || collection.getByCid(id);
        console.log('showSurveyById', model);
        if (model != null) {
          return _this.showSurvey(model);
        } else {
          return _this.navigate('/surveys', true);
        }
      });
    };

    App.prototype.informations = function(id) {
      var addView, collection, listView, mainView, model, view,
        _this = this;
      collection = this.InformationGroups;
      listView = new CollectionView({
        collection: collection,
        itemView: InformationGroupView
      });
      if (id != null) {
        if (id === 'new') {
          window.model = model = new InformationGroup;
          model.on('sync', function() {
            return collection.add(model);
          });
          mainView = new InformationGroupShowView({
            model: model
          });
          view = new SidebarLayout({
            title: 'Informacje',
            backLink: '#/informations',
            mainView: mainView,
            listView: listView
          });
          this.setView(view);
          return collection.load();
        } else {
          return $.when(collection.load()).then(function(collection) {
            if (window.model = model = collection.get(id)) {
              console.log('existing information', model);
              mainView = new InformationGroupShowView({
                model: model
              });
              view = new SidebarLayout({
                title: 'Informacje',
                backLink: '#/informations',
                mainView: mainView,
                listView: listView
              });
              return _this.setView(view);
            } else {
              console.warn("Nie ma elementu o identyfikatorze " + id + ". Przekierowuję do listy elementów.");
              return _this.navigate('/informations', true);
            }
          });
        }
      } else {
        addView = new AddView({
          collection: collection,
          placeholder: 'Tytuł nowego działu'
        });
        addView.on('click', function() {
          return _this.navigate('informations/new', true);
        });
        view = new MenuLayout({
          title: 'Informacje',
          listView: listView,
          addView: addView
        });
        console.log('info');
        this.setView(view);
        return collection.load();
      }
    };

    App.prototype.map = function(id) {
      var addView, collection, listView, mainView, model, view,
        _this = this;
      collection = this.Places;
      listView = new CollectionView({
        collection: collection,
        itemView: PlaceView
      });
      if (id === "new") {
        model = new Place();
        mainView = new PlaceShowView({
          model: model
        });
        view = new SidebarLayout({
          title: 'Mapa',
          backLink: '#/map',
          mainView: mainView,
          listView: listView
        });
        this.setView(view);
        mainView.on('save', function(model) {
          return collection.create(model);
        });
        mainView.on('destroy', function(model) {
          return _this.navigate("/map", true);
        });
        return model.on('sync', function() {
          return _this.navigate("/map/" + model.id, true);
        });
      } else if (id != null) {
        return $.when(collection.load()).then(function(collection) {
          if (model = collection.get(id)) {
            console.log('existing place', model);
            mainView = new PlaceShowView({
              model: model
            });
            mainView.on('save', function(model) {
              return model.save();
            });
            mainView.on('destroy', function(model) {
              model.save();
              collection.remove(model);
              return _this.navigate("/map", true);
            });
            view = new SidebarLayout({
              title: 'Mapa',
              backLink: '#/map',
              mainView: mainView,
              listView: listView
            });
            return _this.setView(view);
          } else {
            console.warn("Nie ma elementu o identyfikatorze " + id + ". Przekierowuję do listy elementów.");
            return _this.navigate('/map', true);
          }
        });
      } else {
        addView = new AddView({
          collection: collection,
          placeholder: 'Nazwa nowego miejsca'
        });
        addView.on('click', function() {
          return _this.navigate('/map/new', true);
        });
        view = new MenuLayout({
          title: 'Mapa',
          listView: listView,
          addView: addView
        });
        this.setView(view);
        return collection.load();
      }
    };

    App.prototype.restaurants = function(id) {
      var MenuItemView, ShowView, addView, collection, listView, mainView, model, path, placeholder, title, view,
        _this = this;
      collection = this.RestaurantUsers;
      title = "Restauracje";
      placeholder = "Nazwa nowej restauracji";
      path = "/restaurants";
      ShowView = RestaurantUserShowView;
      MenuItemView = RestaurantUserView;
      listView = new CollectionView({
        collection: collection,
        itemView: MenuItemView
      });
      if (id === "new") {
        model = new RestaurantUser({
          username: void 0
        });
        mainView = new ShowView({
          model: model,
          collection: collection
        });
        view = new SidebarLayout({
          title: title,
          backLink: "#" + path,
          mainView: mainView,
          listView: listView
        });
        this.setView(view);
        mainView.on('save', function(model) {
          return collection.create(model);
        });
        mainView.on('destroy', function(model) {
          model.destroy();
          return _this.navigate(path, true);
        });
        model.on('sync', function() {
          return _this.navigate("" + path + "/" + (model.id.toURL()), true);
        });
      } else if (id != null) {
        $.when(collection.load()).then(function(collection) {
          if (model = collection.get(id)) {
            mainView = new ShowView({
              model: model
            });
            mainView.on('save', function(model, username, password) {
              return model.destroy({
                success: function() {
                  return collection.create({
                    username: username,
                    password: password
                  }, {
                    success: function() {
                      console.log('after creation');
                      return _this.navigate("" + path + "/" + (model.id.toURL()), true);
                    }
                  });
                }
              });
            });
            mainView.on('destroy', function(model) {
              model.destroy();
              _this.navigate(path, true);
              return $.when(_this.Restaurants.load()).then(function(restaurants) {
                var restaurant;
                if (restaurant = restaurants.find(function(r) {
                  return r.get('name') === model.id;
                })) {
                  return restaurant.save({
                    is_deleted: true
                  });
                }
              });
            });
            view = new SidebarLayout({
              title: title,
              backLink: "#" + path,
              mainView: mainView,
              listView: listView
            });
            return _this.setView(view);
          } else {
            console.warn("Nie ma elementu o identyfikatorze " + id + ". Przekierowuję do listy elementów.");
            return _this.navigate(path, true);
          }
        });
      } else {
        addView = new AddView({
          collection: collection,
          placeholder: placeholder
        });
        addView.on('click', function() {
          return _this.navigate("" + path + "/new", true);
        });
        view = new MenuLayout({
          title: title,
          listView: listView,
          addView: addView
        });
        this.setView(view);
      }
      return collection.load();
    };

    App.prototype.index = function() {
      return this.navigate('/notifications', true);
    };

    App.prototype.updateLinks = function() {
      var hash;
      hash = window.location.hash;
      if (!hash.startsWith('#/')) {
        hash = '#/' + hash.slice(1);
      }
      $("a[href].link").each(function() {
        var active, href;
        href = $(this).attr('href');
        active = hash === href || hash.startsWith(href) && hash.charAt(href.length) === '/';
        return $(this).parent().toggleClass('active', active);
      });
      return $("[data-id]").each(function() {
        var $el, id, parts;
        parts = hash.split('/');
        id = parts[parts.length - 1];
        $el = $(this);
        return $el.toggleClass('active', $el.data('id') === id);
      });
    };

    return App;

  })(Backbone.Router);

  Restaurant = (function(_super) {

    __extends(Restaurant, _super);

    Restaurant.name = 'Restaurant';

    function Restaurant() {
      return Restaurant.__super__.constructor.apply(this, arguments);
    }

    Restaurant.prototype.schemaName = 'restaurant';

    return Restaurant;

  })(StackMob.Model);

  Restaurants = (function(_super) {

    __extends(Restaurants, _super);

    Restaurants.name = 'Restaurants';

    function Restaurants() {
      return Restaurants.__super__.constructor.apply(this, arguments);
    }

    Restaurants.prototype.model = Restaurant;

    Restaurants.prototype.getById = function(id, callback) {
      var q,
        _this = this;
      q = new Restaurants.Query();
      q.equals('restaurant_id', id);
      return this.query(q, {
        success: function(collection) {
          return callback(null, collection.first());
        },
        error: function(e) {
          return callback(e);
        }
      });
    };

    return Restaurants;

  })(StackMob.Collection);

  MenuItem = (function(_super) {

    __extends(MenuItem, _super);

    MenuItem.name = 'MenuItem';

    function MenuItem() {
      return MenuItem.__super__.constructor.apply(this, arguments);
    }

    MenuItem.prototype.schemaName = 'menu_item';

    MenuItem.prototype.validate = function(attrs) {
      if (!attrs.name) {
        return "Musisz podać nazwę";
      }
      if (!attrs.price) {
        return "Musisz podać cenę";
      }
    };

    return MenuItem;

  })(StackMob.Model);

  MenuItems = (function(_super) {

    __extends(MenuItems, _super);

    MenuItems.name = 'MenuItems';

    function MenuItems() {
      return MenuItems.__super__.constructor.apply(this, arguments);
    }

    MenuItems.prototype.model = MenuItem;

    MenuItems.prototype.comparator = function(menuItem) {
      var a;
      a = (menuItem.get('is_featured') ? -1000 : 0) + menuItem.get('price');
      console.log('a', a);
      return a;
    };

    MenuItems.prototype.defaults = {
      is_featured: false
    };

    MenuItems.prototype.getByRestaurantId = function(id, callback) {
      var q,
        _this = this;
      q = new MenuItems.Query();
      q.equals('restaurant', id);
      return this.query(q, {
        success: function(collection) {
          return callback(null, collection);
        },
        error: function(e) {
          return callback(e);
        }
      });
    };

    return MenuItems;

  })(StackMob.Collection);

  RestaurantMenuItemView = (function(_super) {

    __extends(RestaurantMenuItemView, _super);

    RestaurantMenuItemView.name = 'RestaurantMenuItemView';

    function RestaurantMenuItemView() {
      this.render = __bind(this.render, this);

      this.save = __bind(this.save, this);

      this.edit = __bind(this.edit, this);
      return RestaurantMenuItemView.__super__.constructor.apply(this, arguments);
    }

    RestaurantMenuItemView.prototype.template = function() {
      return "<section class=\"menu-item editable {{#if name}} {{else}} active {{/if}}\">\n  <div class=\"configurable show\">\n    <h3>\n      {{#if is_featured}}\n        <i class=\"icon-star\"></i>\n      {{/if}}\n      {{ name }}\n      <small>{{ price }} zł</small>\n    </h3>\n    <p>{{ description }}</p>\n  </div>\n  <div class=\"row-fluid edit\">\n    <form class=\"form-horizontal span12 item\">\n      \n        \n        <div class=\"control-group\">\n          <label for=\"\" class=\"control-label\">Nazwa</label>\n          <div class=\"controls\"><input type=\"text\" class=\"span12 input-name\" value=\"{{ name }}\"/></div>\n        </div>\n        \n        <div class=\"control-group\">\n          <label for=\"\" class=\"control-label\">Cena</label>\n          <div class=\"controls\"><input type=\"text\" class=\"span12 input-price\" value=\"{{ price }}\"/></div>\n        </div>\n        \n        <div class=\"control-group\">\n          <label for=\"\" class=\"control-label\">Opis</label>\n          <div class=\"controls\"><input type=\"text\" class=\"span12 input-description\" value=\"{{ description }}\"/></div>\n        </div>\n        \n        <div class=\"control-group\">\n          <label for=\"\" class=\"control-label\"><i class=\"icon-star\"></i></label>\n          <div class=\"controls\">\n            <label class=\"checkbox\">\n              <input type=\"checkbox\" class=\"span12 input-featured\" {{#if is_featured}}checked{{/if}}/>\n            </label>\n          </div>\n        </div>\n\n        <button class=\"btn btn-primary btn-large save pull-right\">\n          <i class=\"icon-ok icon-white\"></i>\n          Zapisz\n        </button>\n\n    </form>\n  </div>\n</section>";
    };

    RestaurantMenuItemView.prototype.events = {
      'click .show': 'edit',
      'click .save': 'save',
      'submit form': 'save'
    };

    RestaurantMenuItemView.prototype.edit = function(e) {
      return this.$('section').addClass('active');
    };

    RestaurantMenuItemView.prototype.save = function(e) {
      e.preventDefault();
      this.model.set({
        name: this.$('.input-name').val(),
        description: this.$('.input-description').val(),
        price: Number(this.$('.input-price').val()),
        is_featured: !!this.$('.input-featured').attr('checked'),
        restaurant: this.options.restaurant
      });
      return this.model.save();
    };

    RestaurantMenuItemView.prototype.initialize = function() {
      return this.model.on('change', this.render);
    };

    RestaurantMenuItemView.prototype.render = function() {
      console.log('is_featured', this.model.get('is_featured'));
      this.$el.html(this.template().render(this.model.toJSON()));
      return this;
    };

    return RestaurantMenuItemView;

  })(Backbone.View);

  RestaurantView = (function(_super) {

    __extends(RestaurantView, _super);

    RestaurantView.name = 'RestaurantView';

    function RestaurantView() {
      this.render = __bind(this.render, this);

      this.create = __bind(this.create, this);

      this.save = __bind(this.save, this);
      return RestaurantView.__super__.constructor.apply(this, arguments);
    }

    RestaurantView.prototype.itemView = RestaurantMenuItemView;

    RestaurantView.prototype.template = function() {
      return "{{{ restaurantNavbar }}}\n\n<div class=\"container\">\n  \n  <div class=\"row\">\n    <div class=\"span6\">\n        <div class=\"category\">\n          <h1>\n            {{ name }}\n            <small>Informacje o restauracji</small>\n          </h1>\n        </div>\n      <form id=\"restaurant-info-form\">\n      <section class=\"row-fluid item\">\n        <div class=\"span12 form-horizontal\">\n         \n          <div class=\"control-group\">\n            <label for=\"\" class=\"control-label\">Nazwa</label>\n            <div class=\"controls\"><input type=\"text\" disabled class=\"span12\" value=\"{{ name }}\"/></div>\n          </div>\n\n          <div class=\"control-group\">\n            <label for=\"\" class=\"control-label\">Adres</label>\n            <div class=\"controls\"><input type=\"text\" class=\"span12 input-address\" value=\"{{ address }}\"/></div>\n          </div>\n          \n          <div class=\"control-group\">\n            <label for=\"\" class=\"control-label\">Telefon</label>\n            <div class=\"controls\"><input type=\"text\" class=\"span12 input-phone\" value=\"{{ phone }}\"/></div>\n          </div>\n          \n          <div class=\"control-group\">\n            <label for=\"\" class=\"control-label\">Strona www</label>\n            <div class=\"controls\"><input type=\"text\" class=\"span12 input-url\" value=\"{{ url }}\"/></div>\n          </div>\n        </div>\n      </section>\n      <div class=\"form-actions section\">\n        <button class=\"btn btn-primary btn-large pull-right save\">\n          <i class=\"icon-ok icon-white\"></i>\n          Zapisz\n        </button>\n      </div>\n      </form>\n    </div>\n    <div class=\"span6\">\n        <div class=\"category\">\n          <h1>\n            Menu\n          </h1>\n        </div>\n      \n      <div id=\"menu\" class=\"clearfix\">\n        <section class=\"item\">\n          Brak pozycji menu\n        </section>\n      </div>          \n      <div class=\"form-actions section\">\n        <button class=\"btn btn-primary btn-large pull-right create\">\n          <i class=\"icon-plus icon-white\"></i>\n          Dodaj do menu\n        </button>\n      </div>\n    </div>\n  </div>\n  {{{footer}}}\n</div>";
    };

    RestaurantView.prototype.initialize = function() {
      console.log('RestaurantView', this.model);
      this.model.on('change', this.render);
      this.model.on('reset', this.render);
      return RestaurantView.__super__.initialize.apply(this, arguments);
    };

    RestaurantView.prototype.events = {
      'click .save': 'save',
      'submit #restaurant-info-form': 'save',
      'click .create': 'create'
    };

    RestaurantView.prototype.save = function(e) {
      e.preventDefault();
      console.log('save');
      this.model.set({
        address: this.$('.input-address').val(),
        phone: this.$('.input-phone').val(),
        url: this.$('.input-url').val()
      });
      return this.model.save();
    };

    RestaurantView.prototype.create = function(e) {
      e.preventDefault();
      console.log('@collection', this.collection);
      return this.collection.create(new MenuItem);
    };

    RestaurantView.prototype.render = function() {
      this.$el.html(this.template().render(this.model.toJSON()));
      this.$collection = this.$('#menu');
      console.log(this.$collection);
      return RestaurantView.__super__.render.apply(this, arguments);
    };

    return RestaurantView;

  })(CollectionView);

  $(function() {
    var auth, bazylia, displayRestaurantPanelById, loginView, _ref;
    window.globals = {};
    displayRestaurantPanelById = function(id, user) {
      var _this = this;
      return new Restaurants().getById(id, function(error, model) {
        if (error) {
          return console.error("Nie mogę ściągnąć restauracji o id " + id, error);
        } else {
          if (!model) {
            model = new Restaurant({
              restaurant_id: id,
              name: id
            });
            model.create();
          }
          return new MenuItems().getByRestaurantId(id, function(e, collection) {
            var view;
            if (e) {
              return console.error("Nie mogę ściągnąć menu dla restauracji o id " + id, e);
            } else {
              view = new RestaurantView({
                model: model,
                collection: collection,
                restaurant: id
              });
              return $('body').html(view.render().el);
            }
          });
        }
      });
    };
    bazylia = false;
    auth = false;
    if (bazylia) {
      window.globals.current_user = "Bazylia";
      return displayRestaurantPanelById('Bazylia', new User({
        username: "Bazylia",
        role: "restaurant",
        restaurant: "Bazylia"
      }));
    } else {
      if (auth) {
        loginView = new LoginView({
          el: $('body')
        });
        loginView.render();
        return loginView.on('login', function(user) {
          var _this = this;
          window.globals.current_user = user.get('username');
          console.log('login', user);
          return user.fetch({
            success: function() {
              var id, _ref;
              if (user.get('role') === "restaurant") {
                id = user.id;
                return displayRestaurantPanelById(id, user);
              } else {
                window.app = new App({
                  user: user
                });
                return (_ref = Backbone.history) != null ? _ref.start() : void 0;
              }
            }
          });
        });
      } else {
        window.app = new App();
        return (_ref = Backbone.history) != null ? _ref.start() : void 0;
      }
    }
  });

}).call(this);
